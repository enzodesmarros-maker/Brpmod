name: Build Android Mod (.so)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    name: NDK Build arm64-v8a

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install NDK r25c
        run: |
          echo "y" | sdkmanager "ndk;25.2.9519653" 2>/dev/null
          echo "NDK_ROOT=$ANDROID_SDK_ROOT/ndk/25.2.9519653" >> $GITHUB_ENV

      - name: Download KittyMemory
        run: |
          git clone --depth=1 https://github.com/MJx0/KittyMemory \
            app/src/main/cpp/libs/KittyMemory

      - name: Download Dear ImGui
        run: |
          git clone --depth=1 https://github.com/ocornut/imgui \
            app/src/main/cpp/libs/imgui

      - name: Compilar Dobby sem ASM problemático
        run: |
          git clone --depth=1 https://github.com/jmpews/Dobby /tmp/Dobby

          # Remove os .asm que usam sintaxe macOS incompatível com Linux
          find /tmp/Dobby -name "*.asm" -delete

          # Remove referências aos .asm no CMakeLists
          sed -i '/\.asm/d' /tmp/Dobby/CMakeLists.txt || true
          grep -rl "\.asm" /tmp/Dobby/source | xargs sed -i '/\.asm/d' || true

          mkdir -p /tmp/Dobby_build && cd /tmp/Dobby_build
          cmake /tmp/Dobby \
            -DCMAKE_TOOLCHAIN_FILE=$NDK_ROOT/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=arm64-v8a \
            -DANDROID_PLATFORM=android-28 \
            -DANDROID_STL=c++_shared \
            -DCMAKE_BUILD_TYPE=Release \
            -DPlugin.SymbolResolver=OFF \
            -DPlugin.Darwin.HideLibrary=OFF \
            -DPlugin.Darwin.ObjcRuntime=OFF

          cmake --build . -j$(nproc) 2>&1 | tail -30

          mkdir -p $GITHUB_WORKSPACE/app/src/main/cpp/libs/Dobby/arm64-v8a
          mkdir -p $GITHUB_WORKSPACE/app/src/main/cpp/libs/Dobby/include

          find /tmp/Dobby_build -name "*.a" | head -1 | \
            xargs -I{} cp {} \
            $GITHUB_WORKSPACE/app/src/main/cpp/libs/Dobby/arm64-v8a/libdobby.a

          cp /tmp/Dobby/include/dobby.h \
            $GITHUB_WORKSPACE/app/src/main/cpp/libs/Dobby/include/

          ls -lh $GITHUB_WORKSPACE/app/src/main/cpp/libs/Dobby/arm64-v8a/

      - name: Build com ndk-build
        run: |
          cd app/src/main/cpp
          $NDK_ROOT/ndk-build \
            NDK_PROJECT_PATH=. \
            NDK_APPLICATION_MK=Application.mk \
            NDK_LIBS_OUT=./out/libs \
            NDK_OUT=./out/obj \
            -j$(nproc) \
            V=1

      - name: Verificar output
        run: |
          SO=app/src/main/cpp/out/libs/arm64-v8a/libmod.so
          if [ -f "$SO" ]; then
            echo "✅ Build OK"
            ls -lh $SO
            file $SO
          else
            echo "❌ Build FALHOU"
            exit 1
          fi

      - name: Upload libmod.so
        uses: actions/upload-artifact@v4
        with:
          name: libmod-arm64-${{ github.run_number }}
          path: app/src/main/cpp/out/libs/arm64-v8a/libmod.so
          retention-days: 30
          if-no-files-found: error
