name: Build Android Mod (.so)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    name: NDK Build arm64-v8a

    steps:
      # ── 1. Checkout ───────────────────────────────────────────────────────────
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ── 2. Java 17 ────────────────────────────────────────────────────────────
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # ── 3. Android SDK + NDK r25c ─────────────────────────────────────────────
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install NDK r25c
        run: |
          echo "y" | sdkmanager "ndk;25.2.9519653" 2>/dev/null
          echo "NDK_ROOT=$ANDROID_SDK_ROOT/ndk/25.2.9519653" >> $GITHUB_ENV

      # ── 4. Baixar libs automaticamente (sem precisar de submódulos) ───────────
      - name: Download KittyMemory
        run: |
          git clone --depth=1 https://github.com/MJx0/KittyMemory \
            app/src/main/cpp/libs/KittyMemory

      - name: Download Dear ImGui
        run: |
          git clone --depth=1 https://github.com/ocornut/imgui \
            app/src/main/cpp/libs/imgui

      - name: Download e compilar Dobby
        run: |
          git clone --depth=1 https://github.com/jmpews/Dobby \
            /tmp/Dobby
          mkdir -p /tmp/Dobby_build && cd /tmp/Dobby_build
          cmake /tmp/Dobby \
            -DCMAKE_TOOLCHAIN_FILE=$NDK_ROOT/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=arm64-v8a \
            -DANDROID_PLATFORM=android-28 \
            -DANDROID_STL=c++_shared \
            -DCMAKE_BUILD_TYPE=Release \
            -DPlugin.SymbolResolver=OFF
          cmake --build . -j$(nproc)
          # Copia output para o projeto
          mkdir -p $GITHUB_WORKSPACE/app/src/main/cpp/libs/Dobby/arm64-v8a
          mkdir -p $GITHUB_WORKSPACE/app/src/main/cpp/libs/Dobby/include
          cp /tmp/Dobby_build/libdobby.a \
            $GITHUB_WORKSPACE/app/src/main/cpp/libs/Dobby/arm64-v8a/
          cp /tmp/Dobby/include/dobby.h \
            $GITHUB_WORKSPACE/app/src/main/cpp/libs/Dobby/include/

      # ── 5. Build ──────────────────────────────────────────────────────────────
      - name: Build com ndk-build
        run: |
          cd app/src/main/cpp
          $NDK_ROOT/ndk-build \
            NDK_PROJECT_PATH=. \
            NDK_APPLICATION_MK=Application.mk \
            NDK_LIBS_OUT=./out/libs \
            NDK_OUT=./out/obj \
            -j$(nproc) \
            V=0

      # ── 6. Verifica o .so gerado ──────────────────────────────────────────────
      - name: Verificar output
        run: |
          SO=app/src/main/cpp/out/libs/arm64-v8a/libmod.so
          if [ -f "$SO" ]; then
            echo "✅ Build OK: $SO"
            ls -lh $SO
            file $SO
          else
            echo "❌ Build FALHOU"
            exit 1
          fi

      # ── 7. Upload do artifact ─────────────────────────────────────────────────
      - name: Upload libmod.so
        uses: actions/upload-artifact@v4
        with:
          name: libmod-arm64-${{ github.run_number }}
          path: app/src/main/cpp/out/libs/arm64-v8a/libmod.so
          retention-days: 30
          if-no-files-found: error
