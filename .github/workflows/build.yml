name: Build Android Mod (.so)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    name: NDK Build arm64-v8a

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install NDK r25c
        run: |
          echo "y" | sdkmanager "ndk;25.2.9519653" 2>/dev/null
          echo "NDK_ROOT=$ANDROID_SDK_ROOT/ndk/25.2.9519653" >> $GITHUB_ENV

      - name: Download KittyMemory
        run: |
          git clone --depth=1 https://github.com/MJx0/KittyMemory /tmp/KittyMemory
          mkdir -p app/src/main/cpp/libs/KittyMemory
          cp -r /tmp/KittyMemory/KittyMemory/* app/src/main/cpp/libs/KittyMemory/
          echo "Arquivos em libs/KittyMemory:"
          ls app/src/main/cpp/libs/KittyMemory/

      - name: Download Dear ImGui
        run: |
          git clone --depth=1 https://github.com/ocornut/imgui \
            app/src/main/cpp/libs/imgui

      - name: Criar stub do Dobby
        run: |
          mkdir -p app/src/main/cpp/libs/Dobby/arm64-v8a
          mkdir -p app/src/main/cpp/libs/Dobby/include

          cat > app/src/main/cpp/libs/Dobby/include/dobby.h << 'EOF'
          #pragma once
          #ifdef __cplusplus
          extern "C" {
          #endif
          static inline void* DobbyHook(void* addr, void* replace, void** orig) {
              if (orig) *orig = addr;
              return nullptr;
          }
          static inline int DobbyDestroy(void* addr) { return 0; }
          #ifdef __cplusplus
          }
          #endif
          EOF

          AR=$NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar
          $AR rcs app/src/main/cpp/libs/Dobby/arm64-v8a/libdobby.a
          echo "✅ Stub criado"

      - name: Build com ndk-build
        run: |
          cd app/src/main/cpp
          $NDK_ROOT/ndk-build \
            NDK_PROJECT_PATH=. \
            APP_BUILD_SCRIPT=./Android.mk \
            NDK_APPLICATION_MK=./Application.mk \
            NDK_LIBS_OUT=./out/libs \
            NDK_OUT=./out/obj \
            -j$(nproc) \
            V=1

      - name: Verificar output
        run: |
          SO=app/src/main/cpp/out/libs/arm64-v8a/libmod.so
          if [ -f "$SO" ]; then
            echo "✅ Build OK"
            ls -lh $SO
            file $SO
          else
            echo "❌ Build FALHOU"
            find app/src/main/cpp/out -type f 2>/dev/null || true
            exit 1
          fi

      - name: Upload libmod.so
        uses: actions/upload-artifact@v4
        with:
          name: libmod-arm64-${{ github.run_number }}
          path: app/src/main/cpp/out/libs/arm64-v8a/libmod.so
          retention-days: 30
          if-no-files-found: error
