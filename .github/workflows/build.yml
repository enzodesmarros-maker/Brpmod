name: Build Android Mod (.so)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    name: NDK Build arm64-v8a

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install NDK r25c
        run: |
          echo "y" | sdkmanager "ndk;25.2.9519653" 2>/dev/null
          echo "NDK_ROOT=$ANDROID_SDK_ROOT/ndk/25.2.9519653" >> $GITHUB_ENV

      - name: Download KittyMemory
        run: |
          git clone --depth=1 https://github.com/MJx0/KittyMemory \
            app/src/main/cpp/libs/KittyMemory

      - name: Download Dear ImGui
        run: |
          git clone --depth=1 https://github.com/ocornut/imgui \
            app/src/main/cpp/libs/imgui

      - name: Download Dobby pre-compilado
        run: |
          mkdir -p app/src/main/cpp/libs/Dobby/arm64-v8a
          mkdir -p app/src/main/cpp/libs/Dobby/include

          git clone --depth=1 https://github.com/jmpews/Dobby /tmp/Dobby
          cp /tmp/Dobby/include/dobby.h app/src/main/cpp/libs/Dobby/include/

          CLANG=$NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android28-clang++
          AR=$NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar
          mkdir -p /tmp/dobby_obj

          find /tmp/Dobby/source -name "*.cpp" -o -name "*.cc" -o -name "*.c" | \
          grep -v "\.asm\|Darwin\|x86\|x64\|/arm/" | \
          while read f; do
            out="/tmp/dobby_obj/$(echo $f | tr '/' '_').o"
            $CLANG -c "$f" \
              -I /tmp/Dobby/include \
              -I /tmp/Dobby/source \
              -DTARGET_ARCH_ARM64 \
              -std=c++17 -O2 \
              -target aarch64-linux-android28 \
              -o "$out" 2>/dev/null || true
          done

          $AR rcs app/src/main/cpp/libs/Dobby/arm64-v8a/libdobby.a \
            /tmp/dobby_obj/*.o 2>/dev/null || true

          ls -lh app/src/main/cpp/libs/Dobby/arm64-v8a/

      - name: Build com ndk-build
        run: |
          cd app/src/main/cpp
          $NDK_ROOT/ndk-build \
            NDK_PROJECT_PATH=. \
            NDK_APPLICATION_MK=Application.mk \
            NDK_LIBS_OUT=./out/libs \
            NDK_OUT=./out/obj \
            -j$(nproc) \
            V=0

      - name: Verificar output
        run: |
          SO=app/src/main/cpp/out/libs/arm64-v8a/libmod.so
          if [ -f "$SO" ]; then
            echo "✅ Build OK"
            ls -lh $SO
            file $SO
          else
            echo "❌ Build FALHOU"
            exit 1
          fi

      - name: Upload libmod.so
        uses: actions/upload-artifact@v4
        with:
          name: libmod-arm64-${{ github.run_number }}
          path: app/src/main/cpp/out/libs/arm64-v8a/libmod.so
          retention-days: 30
          if-no-files-found: error
